from threading import Thread


class RequestHandler(Thread):

    def __init__(self, client, root_dir):
        Thread.__init__(self)
        self.root_dir = root_dir
        self.client = client

    def run(self):
        print("Incoming connection from {}".format(self.client[1][0])) 
        
        req = ""
        while True:
            try:
                self.client[0].settimeout(0.5)

                data = self.client[0].recv(1024)
            except:
                data = b''
            finally:
                if not data :
                    break
                else:
                    req += data.decode("utf-8")

        print(self.name + '\n' + req)
        headers = req.split('\r\n')

        if 'GET' in headers[0]:
            page = headers[0].split(' ')[1]

        if page[-1] == '/':
            page += "index.html"

        reply = 'HTTP/1.1 200 OKi\r\n'
        reply += 'Content-Type: text/html;charset=UTF-8\r\n'
        reply += 'Connection: close\r\n\r\n'

        with open(self.root_dir + page, 'r') as f:
            for line in f.readlines():
                reply += line

        reply += '\r\n\r\n'
        self.client[0].send(reply.encode())
        self.client[0].close()
